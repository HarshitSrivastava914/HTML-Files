<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Razorpay Subscription Demo</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  </head>
  <body>
    <h1>Subscribe to Monthly Plan</h1>
    <button id="start-subscription">Create Plan & Subscribe</button>

    <script>
      const key_id = "rzp_test_sg_jBej8tGLL9nmJf"; // replace dynamically if needed

      document.getElementById("start-subscription").onclick = async () => {
        try {
          // 1. Create Plan
          const planRes = await fetch("/create-plan", { method: "POST" });
          const planData = await planRes.json();
          if (!planData.id) throw new Error("Failed to create plan");

          // 2. Create Subscription
          const subRes = await fetch("/create-subscription", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ plan_id: planData.id }),
          });
          const subData = await subRes.json();
          if (!subData.id) throw new Error("Failed to create subscription");

          // 3. Open Razorpay checkout for subscription authorization
          const options = {
            key: key_id,
            subscription_id: subData.id,
            handler: async function (response) {
              // response contains razorpay_payment_id, razorpay_subscription_id, razorpay_signature
              console.log("Payment Success:", response);

              // 4. Verify payment signature on backend
              const verifyRes = await fetch("/verify-payment", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  razorpay_payment_id: response.razorpay_payment_id,
                  razorpay_signature: response.razorpay_signature,
                  subscription_id: subData.id,
                }),
              });
              const verifyData = await verifyRes.json();

              if (verifyData.success) {
                alert("Subscription payment verified successfully!");
              } else {
                alert("Payment verification failed!");
              }
            },
            prefill: {
              name: "Alex Lim",
              email: "alex.lim@example.com",
              contact: "+919999999999",
            },
          };

          const rzp = new Razorpay(options);
          rzp.open();
        } catch (err) {
          alert("Error: " + err.message);
        }
      };
    </script>
  </body>
</html>
